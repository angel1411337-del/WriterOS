============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\rahme\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\rahme\IdeaProjects\YouTube Transcript Agent
configfile: pyproject.toml
plugins: anyio-4.11.0, Faker-38.2.0, langsmith-0.4.45, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 21 items

tests/agents/test_tool_calling.py::TestToolRegistry::test_tool_registry_initialization PASSED [  4%]
tests/agents/test_tool_calling.py::TestToolRegistry::test_get_tool_schemas PASSED [  9%]
tests/agents/test_tool_calling.py::TestToolRegistry::test_execute_unknown_tool PASSED [ 14%]
tests/agents/test_tool_calling.py::TestCreateCharacterTool::test_create_character_success PASSED [ 19%]
tests/agents/test_tool_calling.py::TestCreateCharacterTool::test_create_character_duplicate PASSED [ 23%]
tests/agents/test_tool_calling.py::TestCreateCharacterTool::test_create_character_minimal_args PASSED [ 28%]
tests/agents/test_tool_calling.py::TestCreateLocationTool::test_create_location_success PASSED [ 33%]
tests/agents/test_tool_calling.py::TestUpdateCharacterTool::test_update_character_success PASSED [ 38%]
tests/agents/test_tool_calling.py::TestUpdateCharacterTool::test_update_nonexistent_character PASSED [ 42%]
tests/agents/test_tool_calling.py::TestSearchVaultTool::test_search_vault_finds_matches PASSED [ 47%]
tests/agents/test_tool_calling.py::TestSearchVaultTool::test_search_vault_multiple_results PASSED [ 52%]
tests/agents/test_tool_calling.py::TestSearchVaultTool::test_search_vault_no_results PASSED [ 57%]
tests/agents/test_tool_calling.py::TestCreateRelationshipTool::test_create_relationship PASSED [ 61%]
tests/agents/test_tool_calling.py::TestOrchestratorToolIntegration::test_orchestrator_has_tools PASSED [ 66%]
tests/agents/test_tool_calling.py::TestOrchestratorToolIntegration::test_orchestrator_get_tool_schemas PASSED [ 71%]
tests/agents/test_tool_calling.py::TestOrchestratorToolIntegration::test_execute_tool_call PASSED [ 76%]
tests/agents/test_tool_calling.py::TestOrchestratorToolIntegration::test_execute_tool_with_invalid_args PASSED [ 80%]
tests/agents/test_tool_calling.py::TestEndToEndToolCalling::test_complete_workflow_create_character FAILED [ 85%]
tests/agents/test_tool_calling.py::TestToolSafety::test_prevents_duplicate_creation PASSED [ 90%]
tests/agents/test_tool_calling.py::TestToolSafety::test_update_requires_existing_file PASSED [ 95%]
tests/agents/test_tool_calling.py::TestToolSafety::test_search_before_create_workflow PASSED [100%]

================================== FAILURES ===================================
_______ TestEndToEndToolCalling.test_complete_workflow_create_character _______

self = <test_tool_calling.TestEndToEndToolCalling object at 0x000001A468AF5090>
setup_environment = WindowsPath('C:/Users/rahme/AppData/Local/Temp/pytest-of-rahme/pytest-43/test_complete_workflow_create_0/test_vault')
mocker = <pytest_mock.plugin.MockerFixture object at 0x000001A46973F380>
db_session = <sqlmodel.orm.session.Session object at 0x000001A469470D70>
sample_vault_id = UUID('7b01db2a-a2aa-4859-83ca-2a506fe6d19d')

    @pytest.mark.integration
    @pytest.mark.asyncio
    async def test_complete_workflow_create_character(
        self,
        setup_environment,
        mocker,
        db_session,
        sample_vault_id
    ):
        """Test complete workflow of creating a character via tool calling."""
        # Mock embedding service
        mock_embedder = mocker.patch('writeros.agents.orchestrator.get_embedding_service')
        mock_embedder.return_value.embed_query.return_value = [0.1] * 1536
    
        # Mock LLM to return a tool call
        mock_llm = mocker.patch('writeros.utils.llm_client.LLMClient')
        mock_instance = mock_llm.return_value
    
        async def mock_stream(*args, **kwargs):
            # The client expects a chunk with tool_calls
            # We need to mock the structure that the LLMClient expects
    
            # 1. Chunk with tool call
            yield MagicMock(
                choices=[MagicMock(delta=MagicMock(tool_calls=[
                    MagicMock(
                        id="call_123",
                        function=MagicMock(
                            name="create_character_file",
                            arguments='{"name": "Gandalf", "description": "A wise wizard", "role": "supporting"}'
                        )
                    )
                ]))]
            )
    
            # 2. Chunk with content (after tool execution)
            # In a real flow, this would be a separate call, but here we are mocking stream_chat
            # which yields content.
            # Wait, LLMClient.stream_chat yields strings or dicts (for tools).
            # The error comes from the *internal* call to OpenAI client.
            # We are mocking LLMClient, so we should yield what LLMClient yields.
    
            yield {
                "type": "tool_call",
                "id": "call_123",
                "name": "create_character_file",
                "arguments": {
                    "name": "Gandalf",
                    "description": "A wise wizard",
                    "role": "supporting"
                }
            }
            yield "I've created the character file for Gandalf."
    
        # We need to patch the LLMClient instance on the orchestrator, not just the class
        # But Orchestrator instantiates LLMClient in __init__.
        # So we need to patch LLMClient class *before* Orchestrator is initialized.
        # The test does `mock_llm = mocker.patch('writeros.utils.llm_client.LLMClient')`
        # This mocks the class. `mock_instance = mock_llm.return_value` is the instance.
        # `mock_instance.stream_chat = mock_stream` sets the method.
    
        # The error `openai.BadRequestError` suggests that the REAL OpenAI client is being used somewhere
        # or the mock is not taking effect.
        # Ah, `OrchestratorAgent` inherits from `BaseAgent`. `BaseAgent` imports `LLMClient` from `writeros.utils.llm_client`.
        # The test patches `writeros.utils.llm_client.LLMClient`.
        # This should work IF `BaseAgent` imports `LLMClient` at module level.
        # Let's check `writeros/agents/base.py`.
    
        # If the error persists, it means `stream_chat` is NOT mocked and it's calling the real `ainvoke` -> `client.astream`.
        # And since we didn't set an API key or the messages are wrong, it fails.
        # Wait, the error is "Invalid parameter: messages with role 'tool' must be a response..."
        # This validation happens on the OpenAI server side (or library side).
        # This confirms the REAL client is being called.
    
        # WHY is the real client being called if we patched `LLMClient`?
        # Maybe `OrchestratorAgent` imports `LLMClient` differently?
        # Or `BaseAgent` does?
    
        # I will enforce the mock on the instance AFTER initialization to be sure.
        orchestrator = OrchestratorAgent()
        orchestrator.llm = mock_instance
    
        # Mock database queries
        mocker.patch.object(orchestrator, '_create_conversation', return_value=uuid4())
        mocker.patch.object(orchestrator, '_save_message')
        mocker.patch.object(orchestrator, '_retrieve_context', return_value={
            "documents": [],
            "entities": []
        })
    
        # Execute chat
        full_response = ""
        async for chunk in orchestrator.process_chat(
            "Create a character file for Gandalf, a wise wizard",
            sample_vault_id
        ):
            full_response += chunk
    
        # Verify character file was created
        char_file = setup_environment / "Story_Bible" / "Characters" / "Gandalf.md"
>       assert char_file.exists()
E       AssertionError: assert False
E        +  where False = exists()
E        +    where exists = WindowsPath('C:/Users/rahme/AppData/Local/Temp/pytest-of-rahme/pytest-43/test_complete_workflow_create_0/test_vault/Story_Bible/Characters/Gandalf.md').exists

tests\agents\test_tool_calling.py:471: AssertionError
---------------------------- Captured stdout call -----------------------------
2025-11-25 16:56:48 [info     ] llm_client_initialized         model=gpt-5.1
2025-11-25 16:56:48 [info     ] agent_initialized              agent=OrchestratorAgent model=gpt-5.1
2025-11-25 16:56:48 [info     ] llm_client_initialized         model=gpt-5.1
2025-11-25 16:56:48 [info     ] agent_initialized              agent=ProfilerAgent model=gpt-5.1
2025-11-25 16:56:48 [info     ] llm_client_initialized         model=gpt-5.1
2025-11-25 16:56:48 [info     ] agent_initialized              agent=DramatistAgent model=gpt-5.1
2025-11-25 16:56:48 [info     ] dramatist_initialized          agent=DramatistAgent
2025-11-25 16:56:48 [info     ] tools_registry_initialized     agent=OrchestratorAgent vault_path=C:\Users\rahme\AppData\Local\Temp\pytest-of-rahme\pytest-43\test_complete_workflow_create_0\test_vault
2025-11-25 16:56:48 [info     ] agent_selected                 agent=OrchestratorAgent message_snippet='Create a character f' selected_agent=ProfilerAgent
============================== warnings summary ===============================
src\writeros\config.py:4
  C:\Users\rahme\IdeaProjects\YouTube Transcript Agent\src\writeros\config.py:4: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

tests/agents/test_tool_calling.py: 16 warnings
  C:\Users\rahme\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\fields.py:747: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.7-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
src\writeros\__init__.py                                     1      0   100%
src\writeros\agents\__init__.py                             22     10    55%   14-23
src\writeros\agents\architect.py                           136    116    15%   15-16, 22-27, 36-158, 173-210, 220-251, 261-281, 287-305, 311-327
src\writeros\agents\base.py                                 19      2    89%   28-29
src\writeros\agents\chronologist.py                         22      6    73%   25-26, 30-57
src\writeros\agents\dramatist.py                           150    124    17%   38-53, 64-87, 91-114, 118-141, 154-191, 204-248, 252-268, 272-289, 300-317
src\writeros\agents\mechanic.py                             31      6    81%   39-40, 43-68
src\writeros\agents\navigator.py                            26      6    77%   34-35, 38-59
src\writeros\agents\orchestrator.py                        118     48    59%   37-38, 95-118, 133-139, 142-151, 173-210, 226-227, 289, 313-315
src\writeros\agents\producer.py                            203    170    16%   19-27, 30-32, 36-45, 53-63, 67-85, 89-97, 101-110, 114-121, 129-159, 163-199, 207-219, 223-243, 247-264, 272-279, 283-291, 295-305, 313-331, 339-382
src\writeros\agents\profiler.py                            207    158    24%   58-80, 106-274, 285-303, 330-461, 475, 481-529, 541-580
src\writeros\agents\psychologist.py                         40     16    60%   38-39, 42-66, 73-92
src\writeros\agents\stylist.py                              14      7    50%   8, 12-13, 16-49
src\writeros\agents\theorist.py                             34      6    82%   37-39, 42-65
src\writeros\agents\tools.py                                31     31     0%   5-76
src\writeros\agents\tools_registry.py                      129     43    67%   296-304, 377-378, 396, 436-437, 451-496, 538, 548-549, 576-577, 589-620, 659-660
src\writeros\api\__init__.py                                 0      0   100%
src\writeros\api\app.py                                    242    242     0%   13-658
src\writeros\cli\__init__.py                                 0      0   100%
src\writeros\cli\main.py                                    41     41     0%   1-83
src\writeros\config.py                                      16      2    88%   26, 33
src\writeros\core\__init__.py                                0      0   100%
src\writeros\core\logging.py                                13      6    54%   14-42
src\writeros\graphs\__init__.py                              0      0   100%
src\writeros\preprocessing\__init__.py                       4      4     0%   7-23
src\writeros\preprocessing\chunker.py                       78     78     0%   5-143
src\writeros\preprocessing\cluster_semantic_chunker.py     155    155     0%   10-406
src\writeros\preprocessing\unified_chunker.py              160    160     0%   14-405
src\writeros\rag\__init__.py                                 2      2     0%   1-3
src\writeros\rag\retriever.py                              124    124     0%   6-298
src\writeros\schema\__init__.py                             18      0   100%
src\writeros\schema\api.py                                  22      0   100%
src\writeros\schema\base.py                                 12      0   100%
src\writeros\schema\enums.py                               132      0   100%
src\writeros\schema\extended_universe.py                    90      0   100%
src\writeros\schema\graph.py                                16      0   100%
src\writeros\schema\identity.py                             41      0   100%
src\writeros\schema\library.py                              74      9    88%   51-61, 127
src\writeros\schema\logistics.py                            17      0   100%
src\writeros\schema\mechanics.py                            20      0   100%
src\writeros\schema\narrative.py                            19      0   100%
src\writeros\schema\project.py                              13      0   100%
src\writeros\schema\prose.py                                14      0   100%
src\writeros\schema\psychology.py                           37      0   100%
src\writeros\schema\session.py                              27      0   100%
src\writeros\schema\temporal_anchoring.py                   54      0   100%
src\writeros\schema\theme.py                                16      0   100%
src\writeros\schema\world.py                                80      0   100%
src\writeros\services\__init__.py                            0      0   100%
src\writeros\services\conflict_engine.py                    31     21    32%   11-16, 20-44, 48-64
src\writeros\tasks\__init__.py                               0      0   100%
src\writeros\utils\db.py                                   143    121    15%   17-23, 70-148, 162-241, 251-252, 262-284, 291-302, 310-325, 336-346
src\writeros\utils\embeddings.py                            41     18    56%   22-29, 32-42, 46, 50, 54, 65, 75
src\writeros\utils\llm_client.py                            54     38    30%   56-99, 122-135, 152-156
src\writeros\utils\writer.py                               178    133    25%   33-43, 47-49, 52, 58-62, 87-89, 93-130, 135-194, 197-235, 238-266, 269-274, 278-366
--------------------------------------------------------------------------------------
TOTAL                                                     3167   1903    40%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/agents/test_tool_calling.py::TestEndToEndToolCalling::test_complete_workflow_create_character
================== 1 failed, 20 passed, 17 warnings in 4.62s ==================
