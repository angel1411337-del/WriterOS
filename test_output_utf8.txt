============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\rahme\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\rahme\IdeaProjects\YouTube Transcript Agent
configfile: pyproject.toml
plugins: anyio-4.11.0, Faker-38.2.0, langsmith-0.4.45, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 2 items

tests/integration/test_conflict_integration.py::test_architect_conflict_integration FAILED [ 50%]
tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration FAILED [100%]

================================== FAILURES ===================================
_____________________ test_architect_conflict_integration _____________________

db_session = <sqlmodel.orm.session.Session object at 0x00000221AA56C050>

    @pytest.mark.asyncio
    async def test_architect_conflict_integration(db_session):
        # 1. Setup Data
        vault_id = uuid4()
    
        conflict = Conflict(
            vault_id=vault_id,
            name="The Long War",
            conflict_type=ConflictType.PERSON_VS_SOCIETY,
            status=ConflictStatus.RISING_ACTION,
            stakes="Freedom",
            intensity=80
        )
        db_session.add(conflict)
        db_session.commit()
    
        # 2. Run Architect
        architect = ArchitectAgent()
        tasks = await architect.generate_plot_tasks(vault_id)
    
        # 3. Verify
>       assert len(tasks) > 0
E       assert 0 > 0
E        +  where 0 = len([])

tests\integration\test_conflict_integration.py:32: AssertionError
---------------------------- Captured stdout call -----------------------------
2025-11-24 22:26:46 [info     ] agent_initialized              agent=ArchitectAgent model=gpt-5.1
2025-11-24 22:26:46 [info     ] generating_plot_tasks          agent=ArchitectAgent vault_id=b04db3dd-f599-468e-9e6d-f15d82abfdb9
_____________________ test_dramatist_conflict_integration _____________________

self = <sqlalchemy.engine.base.Connection object at 0x00000221AAFFB050>
dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x00000221AA322BA0>
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x00000221AAFF9D50>
statement = <sqlalchemy.dialects.postgresql.base.PGCompiler object at 0x00000221AB0E47D0>
parameters = [{'status_2': 'RESOLUTION', 'vault_id_2': UUID('3b5bfca0-51d1-48b3-af98-eab96ba81f33')}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x00000221AA322BA0>
cursor = <cursor object at 0x00000221AB0BB5A0; closed: -1>
statement = 'SELECT conflicts.created_at, conflicts.updated_at, conflicts.id, conflicts.vault_id, conflicts.name, conflicts.confli...WHERE conflicts.vault_id = %(vault_id_2)s::UUID AND conflicts.status != %(status_2)s ORDER BY conflicts.intensity DESC'
parameters = {'status_2': 'RESOLUTION', 'vault_id_2': UUID('3b5bfca0-51d1-48b3-af98-eab96ba81f33')}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x00000221AAFF9D50>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       psycopg2.errors.UndefinedColumn: column entities.status does not exist
E       LINE 1: ...e, entities.name AS name_1, entities.description, entities.s...
E                                                                    ^
E       HINT:  Perhaps you meant to reference the column "entities.tags".

..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py:951: UndefinedColumn

The above exception was the direct cause of the following exception:

db_session = <sqlmodel.orm.session.Session object at 0x00000221AAF3A990>

    @pytest.mark.asyncio
    async def test_dramatist_conflict_integration(db_session):
        # 1. Setup Data
        vault_id = uuid4()
    
        hero = Entity(vault_id=vault_id, name="Hero", type=EntityType.CHARACTER)
        db_session.add(hero)
        db_session.commit()
    
        conflict = Conflict(
            vault_id=vault_id,
            name="Nemesis Duel",
            conflict_type=ConflictType.PERSON_VS_PERSON,
            status=ConflictStatus.CLIMAX,
            stakes="Life or Death",
            intensity=95
        )
        db_session.add(conflict)
        db_session.commit()
    
        participant = ConflictParticipant(
            conflict_id=conflict.id,
            entity_id=hero.id,
            role=ConflictRole.PROTAGONIST
        )
        db_session.add(participant)
        db_session.commit()
    
        # 2. Run Dramatist
        dramatist = DramatistAgent()
>       instructions = await dramatist.generate_scene_instructions(vault_id, [str(hero.id)])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_conflict_integration.py:65: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\writeros\agents\dramatist.py:302: in generate_scene_instructions
    tension_map = self.conflict_engine.get_tension_map(vault_id)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\writeros\services\conflict_engine.py:31: in get_tension_map
    results = session.exec(statement).all()
              ^^^^^^^^^^^^^^^^^^^^^^^
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlmodel\orm\session.py:83: in exec
    results = super().execute(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:2351: in execute
    return self._execute_internal(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\context.py:306: in orm_execute_statement
    result = conn.execute(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1846: in _execute_context
    return self._exec_single_context(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\base.py:1967: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x00000221AA322BA0>
cursor = <cursor object at 0x00000221AB0BB5A0; closed: -1>
statement = 'SELECT conflicts.created_at, conflicts.updated_at, conflicts.id, conflicts.vault_id, conflicts.name, conflicts.confli...WHERE conflicts.vault_id = %(vault_id_2)s::UUID AND conflicts.status != %(status_2)s ORDER BY conflicts.intensity DESC'
parameters = {'status_2': 'RESOLUTION', 'vault_id_2': UUID('3b5bfca0-51d1-48b3-af98-eab96ba81f33')}
context = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x00000221AAFF9D50>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedColumn) column entities.status does not exist
E       LINE 1: ...e, entities.name AS name_1, entities.description, entities.s...
E                                                                    ^
E       HINT:  Perhaps you meant to reference the column "entities.tags".
E       
E       [SQL: SELECT conflicts.created_at, conflicts.updated_at, conflicts.id, conflicts.vault_id, conflicts.name, conflicts.conflict_type, conflicts.status, conflicts.intensity, conflicts.stakes, conflicts.resolution, conflicts.canon, conflicts.embedding, conflict_participants.id AS id_1, conflict_participants.conflict_id, conflict_participants.entity_id, conflict_participants.role, conflict_participants.outcome, entities.created_at AS created_at_1, entities.updated_at AS updated_at_1, entities.id AS id_2, entities.vault_id AS vault_id_1, entities.type, entities.name AS name_1, entities.description, entities.status AS status_1, entities.aliases, entities.species, entities.birth_date, entities.death_date, entities.properties, entities.tags, entities.canon AS canon_1, entities.embedding AS embedding_1 
E       FROM conflicts JOIN conflict_participants ON conflicts.id = conflict_participants.conflict_id JOIN entities ON conflict_participants.entity_id = entities.id 
E       WHERE conflicts.vault_id = %(vault_id_2)s::UUID AND conflicts.status != %(status_2)s ORDER BY conflicts.intensity DESC]
E       [parameters: {'vault_id_2': UUID('3b5bfca0-51d1-48b3-af98-eab96ba81f33'), 'status_2': 'RESOLUTION'}]
E       (Background on this error at: https://sqlalche.me/e/20/f405)

..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\default.py:951: ProgrammingError
---------------------------- Captured stdout call -----------------------------
2025-11-24 22:26:47 [info     ] agent_initialized              agent=DramatistAgent model=gpt-5.1
2025-11-24 22:26:47 [info     ] dramatist_initialized          agent=DramatistAgent
2025-11-24 22:26:47 [info     ] generating_scene_instructions  agent=DramatistAgent characters=['893081c2-1bcb-4964-8d21-02c3ce95bbc8'] vault_id=3b5bfca0-51d1-48b3-af98-eab96ba81f33
============================== warnings summary ===============================
src\writeros\config.py:4
  C:\Users\rahme\IdeaProjects\YouTube Transcript Agent\src\writeros\config.py:4: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

tests/integration/test_conflict_integration.py::test_architect_conflict_integration
tests/integration/test_conflict_integration.py::test_architect_conflict_integration
tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration
tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration
tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration
tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration
  C:\Users\rahme\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\fields.py:747: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.7-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
src\writeros\__init__.py                                     1      0   100%
src\writeros\agents\__init__.py                             22     10    55%   14-23
src\writeros\agents\architect.py                           136    109    20%   22-27, 36-158, 173-210, 220-251, 261-281, 287-305, 320-325
src\writeros\agents\base.py                                 22      2    91%   31-32
src\writeros\agents\chronologist.py                         22      6    73%   25-26, 30-57
src\writeros\agents\dramatist.py                           150    122    19%   38-53, 64-87, 91-114, 118-141, 154-191, 204-248, 252-268, 272-289, 303-317
src\writeros\agents\mechanic.py                             31      6    81%   39-40, 43-68
src\writeros\agents\navigator.py                            26      6    77%   34-35, 38-59
src\writeros\agents\orchestrator.py                         68     68     0%   5-149
src\writeros\agents\producer.py                            203    170    16%   19-27, 30-32, 36-45, 53-63, 67-85, 89-97, 101-110, 114-121, 129-159, 163-199, 207-219, 223-243, 247-264, 272-279, 283-291, 295-305, 313-331, 339-382
src\writeros\agents\profiler.py                            201    154    23%   54-55, 58-80, 106-274, 285-303, 330-461, 475, 478, 490-529
src\writeros\agents\psychologist.py                         40     16    60%   38-39, 42-66, 73-92
src\writeros\agents\stylist.py                              14      7    50%   8, 12-13, 16-49
src\writeros\agents\theorist.py                             34      6    82%   37-39, 42-65
src\writeros\agents\tools.py                                31     31     0%   5-76
src\writeros\api\__init__.py                                 0      0   100%
src\writeros\api\app.py                                     12     12     0%   1-21
src\writeros\cli\__init__.py                                 0      0   100%
src\writeros\cli\main.py                                    41     41     0%   1-83
src\writeros\config.py                                      16      2    88%   26, 33
src\writeros\core\__init__.py                                0      0   100%
src\writeros\core\logging.py                                13      6    54%   14-42
src\writeros\graphs\__init__.py                              0      0   100%
src\writeros\preprocessing\__init__.py                       4      4     0%   7-23
src\writeros\preprocessing\chunker.py                       78     78     0%   5-143
src\writeros\preprocessing\cluster_semantic_chunker.py     155    155     0%   10-406
src\writeros\preprocessing\unified_chunker.py              160    160     0%   14-405
src\writeros\rag\__init__.py                                 2      2     0%   1-3
src\writeros\rag\retriever.py                               74     74     0%   5-171
src\writeros\schema\__init__.py                             16      0   100%
src\writeros\schema\api.py                                  22      0   100%
src\writeros\schema\base.py                                 12      0   100%
src\writeros\schema\enums.py                               132      0   100%
src\writeros\schema\graph.py                                16      0   100%
src\writeros\schema\identity.py                             41      0   100%
src\writeros\schema\library.py                              74      9    88%   51-61, 127
src\writeros\schema\logistics.py                            17      0   100%
src\writeros\schema\mechanics.py                            20      0   100%
src\writeros\schema\narrative.py                            19      0   100%
src\writeros\schema\project.py                              13      0   100%
src\writeros\schema\prose.py                                14      0   100%
src\writeros\schema\psychology.py                           37      0   100%
src\writeros\schema\session.py                              27      0   100%
src\writeros\schema\theme.py                                16      0   100%
src\writeros\schema\world.py                                80      0   100%
src\writeros\services\__init__.py                            0      0   100%
src\writeros\services\conflict_engine.py                    31     15    52%   33-44, 48-64
src\writeros\tasks\__init__.py                               0      0   100%
src\writeros\utils\db.py                                   143    121    15%   17-23, 70-148, 162-241, 251-252, 262-284, 291-302, 310-325, 336-346
src\writeros\utils\embeddings.py                            41     18    56%   22-29, 32-42, 46, 50, 54, 65, 75
--------------------------------------------------------------------------------------
TOTAL                                                     2327   1410    39%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/integration/test_conflict_integration.py::test_architect_conflict_integration - assert 0 > 0
 +  where 0 = len([])
FAILED tests/integration/test_conflict_integration.py::test_dramatist_conflict_integration - sqlalchemy.exc.ProgrammingError: (psycopg2.errors.UndefinedColumn) column entities.status does not exist
LINE 1: ...e, entities.name AS name_1, entities.description, entities.s...
                                                             ^
HINT:  Perhaps you meant to reference the column "entities.tags".

[SQL: SELECT conflicts.created_at, conflicts.updated_at, conflicts.id, conflicts.vault_id, conflicts.name, conflicts.conflict_type, conflicts.status, conflicts.intensity, conflicts.stakes, conflicts.resolution, conflicts.canon, conflicts.embedding, conflict_participants.id AS id_1, conflict_participants.conflict_id, conflict_participants.entity_id, conflict_participants.role, conflict_participants.outcome, entities.created_at AS created_at_1, entities.updated_at AS updated_at_1, entities.id AS id_2, entities.vault_id AS vault_id_1, entities.type, entities.name AS name_1, entities.description, entities.status AS status_1, entities.aliases, entities.species, entities.birth_date, entities.death_date, entities.properties, entities.tags, entities.canon AS canon_1, entities.embedding AS embedding_1 
FROM conflicts JOIN conflict_participants ON conflicts.id = conflict_participants.conflict_id JOIN entities ON conflict_participants.entity_id = entities.id 
WHERE conflicts.vault_id = %(vault_id_2)s::UUID AND conflicts.status != %(status_2)s ORDER BY conflicts.intensity DESC]
[parameters: {'vault_id_2': UUID('3b5bfca0-51d1-48b3-af98-eab96ba81f33'), 'status_2': 'RESOLUTION'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
======================== 2 failed, 7 warnings in 4.62s ========================
